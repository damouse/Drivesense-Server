<% provide(:title, 'Manage Trips') %>
<%= include_gon %>

<div class="container trip-viewer-container" >
  <div class="row fill">

    <div class="col-md-7 fill">
      <div id="map-canvas" class="well" onload="initialize"></div>  
      <div id="graph"></div>
    </div>
    <div class="hidden-lg hidden-md"><hr/></div>
    <div class="col-md-5 fill" id="right-side">
      <div class= "row" id="selectors" height:"30%">
        <div class = "col-xs-6">
          <input class = "calSpeed form-control" value="" onchange="update()" readonly="true" id="from" name="from">
        </div>
        <div class = "col-xs-6">
          <input class = "calSpeed form-control" value="" onchange="update()" readonly="true" id="to" name="to">
        </div>
      </div>
      <hr/>
      <div class="row">
        <div class = "col-xs-6">
          <h3 class="short-header">Events</h3>
          <div class="checkbox">
            <label>
              <input onclick="drawChart()" checked type="checkbox" id="brakes" value="">
              Brakes
            </label>
          </div>
          <div class="checkbox">
            <label>
              <input onclick="drawChart()" checked type="checkbox" id="accelerations" value="">
              Accelerations
            </label>
          </div>
          <div class="checkbox">
            <label>
              <input onclick="drawChart()" checked type="checkbox" id="turns" value="">
              Turns
            </label>
          </div>
        </div>
        <div class = "col-xs-6">
          <h3 class='short-header'>Analytics</h3>
          <div class="radio">
            <label>
              <input onclick="drawChart()" type="radio" name="optionsRadios" value="option1" id="scores" checked>
              Scores
            </label>
          </div>
          <div class="radio">
            <label>
              <input onclick="drawChart()" type="radio" name="optionsRadios" value="option2" id="speeds">
              Speed
            </label>
          </div>
          
        </div>
      </div>
      <hr/>
      <div id="trip-table">
          <div id="accordion"> 
          </div>
      </div>

  </div>

  <div id="trips_data_text"></div>
  <div id="trips_range_text"></div>
</div>


<script>
function update(){
  var start = $('#from').datepicker('getDate');
  var end = $('#to').datepicker('getDate');
  start = datePickerToTime(start);
  end = datePickerToTime(end);
  var target = document.getElementById('trip-table');
  spinner = new Spinner(opts).spin(target);
  trips_with_range(u_list, start, end);
}
var tzoff;
function getTzOff(time){
  tzoff = 0 - time.getTimezoneOffset()/60
  if (tzoff > 0){
    tzoff = "+" + tzoff;
  }
  return tzoff;
}
function reasonableTime(time){
   var retTime = time.getFullYear() + "-" + (time.getMonth() + 1) + "-" + time.getDate() + " " + time.getHours() + ":" + time.getMinutes() + ":" + time.getSeconds() + " " + getTzOff(time);
   return retTime
}
function datePickerToTime(date){
  //TODO: actual timezone
  
  var retTime = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " 00:00:00 " + tzoff;
  return retTime
}
var spinner;
var opts = {
    lines: 13, // The number of lines to draw
    length: 20, // The length of each line
    width: 10, // The line thickness
    radius: 30, // The radius of the inner circle
    corners: 1, // Corner roundness (0..1)
    rotate: 0, // The rotation offset
    direction: 1, // 1: clockwise, -1: counterclockwise
    color: '#000', // #rgb or #rrggbb or array of colors
    speed: 1, // Rounds per second
    trail: 60, // Afterglow percentage
    shadow: false, // Whether to render a shadow
    hwaccel: false, // Whether to use hardware acceleration
    className: 'spinner', // The CSS class to assign to the spinner
    zIndex: 2e9, // The z-index (defaults to 2000000000)
    top: '50%', // Top position relative to parent
    left: '50%' // Left position relative to parent
};
var u_list = []
$( document ).ready(function() {
  $( "#accordion" ).accordion({
    collapsible:true,
    heightStyle: "content"
  });
  $( ".trip" ).hover(function(){
    $(this).toggleClass('.trip.hover');
  })
  $( "#from" ).datepicker({
    dateFormat: 'yy-mm-dd'
  });
  $( "#to" ).datepicker({
    dateFormat: 'yy-mm-dd'
  });
  to = new Date();
  from = new Date();
  from.setDate(from.getDate() - 365);
  $("#to").datepicker("setDate" , to);
  $("#from").datepicker("setDate" , from);
  var now = new Date();
  now = reasonableTime(now);
  var oYA = new Date();
  oYA.setDate(oYA.getDate() - 365);
  oYA = reasonableTime(oYA);
  var target = document.getElementById('trip-table');
  spinner = new Spinner(opts).spin(target);
  u_list = []
  if (gon.current_user == -1){
    for (var q = 0; q < gon.groups.members.length; q++){
      u_list.push(gon.groups.members[q].id);
    }
  }
  else{
    u_list.push(gon.current_user);
  }
  trips_with_range(u_list, oYA, now);
  initialize();
});
var map;
function initialize() {
  var mapOptions = {
    //TODO: Better Center
    center: new google.maps.LatLng(43.06, -89.4),
    zoom: 15,
    panControl: true
  };
  map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
}
// google.maps.event.addDomListener(window, 'load', initialize);
var user_json;
function updateUserJSON(){
  user_json = jQuery.parseJSON($("#trips_range_text").html())
  var lis = ""
  for (var i = 0, u; i <user_json.users.length; i++) {
     lis = lis.concat("<h3>");
     u = user_json.users[i];
     lis = lis.concat(u.email);
     lis = lis.concat("</h3>");
     if (u.trips.length == 0){
       lis = lis.concat("<div><p>No Trips!</p></div>");
     }
     else {
       lis = lis.concat("<div><p><ul class='list-group'>");
       for (var j = 0, t; j <u.trips.length; j++){
         var color = "#" + Math.random().toString(16).slice(2, 8)
         //var color = "#000000"
         var cc;
         if (u.trips[j].score.scoreAverage > 90){
           cc = "btn btn-success"
         }else if (u.trips[j].score.scoreAverage > 80){
           cc = "btn btn-warning"
         }
         else{
           cc = "btn btn-danger"
         }
         //TODO: Duration
         lis = lis.concat("<li value=" + u.trips[j].id + " class='list-group-item trip'")
         lis = lis.concat(color + " onclick='selected(" + u.trips[j].id + ")'><div class='row'><div class='col-xs-3'><b>");
         d = new Date(u.trips[j].time_stamp);
         lis = lis.concat(u.trips[j].name + "</b></div><div class='col-xs-3'>" + timeSince(d)) + "</div>";
         lis = lis.concat("<div class='col-xs-4'>"+Math.ceil(u.trips[j].duration/60)+" minutes </div>");
         lis = lis.concat("<div class='col-xs-2'><span class='badge pull-right " + cc + "'>");
         lis = lis.concat(u.trips[j].score.scoreAverage);
         lis = lis.concat("</button></div></div></li>");
         drawRoute(u.trips[j],color);
       }
       lis = lis.concat("</ul></p></div>");
     } 
  }
  $("#accordion").html(lis);
  $("#accordion").accordion("refresh");

  spinner.stop();
}
// script to resize mapsmarker maps on screen resolutions or window resize smaller then 640px
$(function(){
  var windowWidth = $(window).width();
  if (windowWidth <= 640) {
     $('#map-canvas').css({
      'width': '90%',
      'margin-left' : 'auto',
      'margin-right': 'auto'
     });
    }
    $(window).on('resize', function(){
      var win = $(this); //this = window
      if (win.width() <= 640) {
        $('#map-canvas').css({
          'width' : '90%',
          'margin-left' : 'auto',
          'margin-right' : 'auto'
        });
      }
      else {
       $('#map-canvas').css({
        'width' : '100%'
       });
      }
    });
});
var coordCircle
var linelist = [];
var smlist = []
var emlist = []
function drawRoute(trip,color){
  var tripCoordinates = [];
  for (var i = 0; i < trip.coordinates.length; i++){
    tripCoordinates.push(new google.maps.LatLng(trip.coordinates[i].latitude, trip.coordinates[i].longitude));
  }
  var start_marker = new google.maps.Marker({
    position: new google.maps.LatLng(trip.coordinates[0].latitude, trip.coordinates[0].longitude),
    title: "Start",
    icon: "/assets/car_map.png"
  });
  var end_marker = new google.maps.Marker({
    position: new google.maps.LatLng(trip.coordinates[trip.coordinates.length - 1].latitude, trip.coordinates[trip.coordinates.length - 1].longitude),
    title:"End",
    icon: "/assets/stop.png"
  });
  start_marker.setMap(map);
  end_marker.setMap(map);
  var tripPath = new google.maps.Polyline({
   path: tripCoordinates,
   geodesic: true,
   strokeColor: color,
   strokeOpacity: 1.0,
   strokeWeight: 3
  });
   
  half = parseInt(trip.coordinates.length/2);
  lat = trip.coordinates[0].latitude
  lon = trip.coordinates[0].longitude
  map.setCenter(new google.maps.LatLng(lat,lon));
  linelist.push(tripPath);
  smlist.push(start_marker);
  emlist.push(end_marker);
  index = linelist.length - 1;
  google.maps.event.addListener(linelist[index],'click', function() {
    selected(trip.id);
  });
  google.maps.event.addListener(smlist[index],'click', function() {
    selected(trip.id);
  });
  google.maps.event.addListener(emlist[index],'click', function() {
    selected(trip.id);
  });
  
  tripPath.setMap(map);
}
google.maps.event.addDomListener(window, 'load', initialize);
function timeSince(date) {

    var seconds = Math.floor((new Date() - date) / 1000);

    var interval = Math.floor(seconds / 31536000);

    if (interval > 1) {
        return interval + " years ago";
    }
    interval = Math.floor(seconds / 2592000);
    if (interval > 1) {
        return interval + " months ago";
    }
    interval = Math.floor(seconds / 86400);
    if (interval > 1) {
        return interval + " days ago";
    }
    interval = Math.floor(seconds / 3600);
    if (interval > 1) {
        return interval + " hours ago";
    }
    interval = Math.floor(seconds / 60);
    if (interval > 1) {
        return interval + " minutes ago";
    }
    return Math.floor(seconds) + " seconds ago";
}
var drawn = {}
function drawChart(){
   for (var key in drawn){
     for (var f = 0; f < drawn[key].length; f++) {
       drawn[key][f].setMap(null);
     }
   }
   dic_list = [];
   var mode;
   var list_to_graph;
   trips_json = jQuery.parseJSON($("#trips_data_text").html());
   if ($('#speeds').is(':checked')){
     mode = "speed";
     user_json = jQuery.parseJSON($("#trips_range_text").html());
     list_to_graph = []
     for (var q = 0; q < user_json.users.length; q++){
       for(var r = 0; r < user_json.users[q].trips.length; r++){
         if ($.inArray(user_json.users[q].trips[r].id, all_selected)>-1){
           list_to_graph.push(user_json.users[q].trips[r]);
         }
       } 
     }
   }
   else{
     mode = "score";
     list_to_graph = trips_json.trips
   }
   for (var j = 0; j < list_to_graph.length; j++){ 
     var dic = {};
     dic['name'] = list_to_graph[j].name;
     dic['data'] = []
     var trip_coords;
     var trip_id;
     var lower_list;
     if (mode == "score"){
       ini = list_to_graph[j].score.patterns[0].start_time
       lower_list = list_to_graph[j].score.patterns
       for (var m = 0; m<user_json.users.length; m++){
         for (var n = 0; n<user_json.users[m].trips.length; n++){
         if (user_json.users[m].trips[n].id == trips_json.trips[j].id){
             trip_id = user_json.users[m].trips[n].id
             trip_coords = user_json.users[m].trips[n].coordinates;
           }
         }
     }
     }else{
       ini = list_to_graph[j].time_stamp;
       lower_list  = list_to_graph[j].coordinates;
       trip_id = list_to_graph[j].id;
       trip_coords = list_to_graph[j].coordinates;
     }
     drawn[trip_id] = []
     checked_list = []
     if ($('#turns').is(':checked')){
       checked_list.push("turn");
     }
     if ($('#accelerations').is(':checked')){
       checked_list.push("acceleration");
     }
     if ($('#brakes').is(':checked')){
       checked_list.push("brake");
     }
     for (var i = 0; i < lower_list.length; i++){
       tmp_dic = {};
       var z = lower_list[i];
       if (mode == "score"){
         tmp_dic['x'] = (Math.abs(new Date(z.start_time) - new Date(ini)))/60000;
         tmp_dic['name'] = z.pattern_type;
         if ($.inArray(tmp_dic['name'], checked_list)<0){
           continue;
         }
         tmp_dic['y'] = z.raw_score;
         tmp_dic['gps_id'] = z.gps_index_start
       }
       else if (mode == "speed"){
         tmp_dic['x'] = (Math.abs(new Date(z.time_stamp) - new Date(ini)))/60000;
         tmp_dic['name'] = "speed";
         tmp_dic['y'] = z.speed;
         tmp_dic['gps_id'] = z.gps_id;
       }
       for (var e = 0; e < trip_coords.length; e++){
         if (trip_coords[e].gps_id == tmp_dic.gps_id){
           tmp_dic['events'] = {}
           tmp_dic['lat'] = trip_coords[e].latitude
           tmp_dic['lon'] = trip_coords[e].longitude
           tmp_dic['events']['click'] = function(){map.setCenter(new google.maps.LatLng(this.lat,this.lon))};
           var color;
           if (mode == "score"){
             if (tmp_dic['y'] >90){
               color = "#008000";
             }else if (tmp_dic['y'] >80){
               color = "#FFFF00";
             }else{
               color = "#FF0000";
             }
           }else{
             if (tmp_dic['y'] >50){
               color = "#008000";
             }else if (tmp_dic['y'] > 40){
               color = "#66FF66";
             }
             else if (tmp_dic['y'] > 30){
               color = "#FFFF00";
             }
             else if (tmp_dic['y'] > 20){
               color = "#FFCC66";
             }
             else if (tmp_dic['y'] > 10){
               color = "#FF9933"; 
             }
             else if (tmp_dic['y'] > 5){
               color = "#FF9900";
             }
             else{
               color = "#FF0000";
             }
           }
           var circleOptions = {
             map: map,
             center: new google.maps.LatLng(trip_coords[e].latitude,trip_coords[e].longitude),
             radius: 20,
             fillOpacity: 0.6,
             fillColor: color,
             strokeColor: color,
             strokeOpacity: 0.6,
           }
           circle = new google.maps.Circle(circleOptions)
           drawn[trip_id].push(circle);
         }
       }
       if (tmp_dic['y'] > 0){
         dic['data'].push(tmp_dic);
       }  
     }
     dic_list.push(dic);
   }
   var $reporting = $('#reporting');
   if (mode == "score"){
     text = "score"
   }else{
     text = "speed (mph)"
   }
   $('#graph').highcharts({
        plotOptions: {
            series: {
                turboThreshold: 0,
                point: {
                    events: {
                          mouseOver: function() {
                              $reporting.html('value: '+ this.y + ' pattern: ' + this.name);
                          }
                    }
                },
                events: {
                    mouseOut: function() {                        
                        $reporting.empty();
                    }
                }
            }
        },
        credits: {
            enabled: false
        },
        chart: {
            type: 'scatter',
            zoomType: 'xy'
        },
        title: {
            text: 'Chart'
        },
        tooltip: {
            formatter: function() {
                return 'Type: <b>'+ this.point.name +
                    '</b> Score: <b>'+ this.y +'</b>';
            }
        },
        xAxis: {
            title: {
                text: 'time (minutes)'
            }
        },
        yAxis: {
            title: {
                text: text
            },
            min: 0,
        },
        series: dic_list
    });
}
var all_selected = []
var look;
function selected(trip_id){
  if ($.inArray(trip_id, all_selected)>-1){
    all_selected.splice( $.inArray(trip_id, all_selected), 1 );
  }else{
    all_selected.push(trip_id);
    
  }
  if (all_selected.length > 0){
    $('#map-canvas').animate({height: '60%'},200,function(){$('#graph').css('height','40%');  $('#graph').show(); trips_data(all_selected);google.maps.event.trigger(map, 'resize');}); 
  }
  else{
    trips_data(all_selected)
    $('#graph').hide();
    $('#graph').animate({height:'0%'});
    //$('#map-canvas').animate({height: '100%%'});
    $('#map-canvas').css('height','100%%');
    google.maps.event.trigger(map, 'resize');
  }
  $('.trip').each(function() {
    if ($.inArray($(this).val(), all_selected) >= 0){
      $(this).addClass('blue');
    }else{
      $(this).removeClass('blue');
    }
    look = $(this);
  });
}
</script>
